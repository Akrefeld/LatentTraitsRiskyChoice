---
title: "InititalAnalysis"
author: "Antonia"
date: "12 11 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(knitr)
library(stringr)
```


```{r load}
data = read.csv("data.csv", sep = ";")
dataFit = read.csv("mixed_bic_values.csv", sep = ";")
#str(dataFit)
#sort(apply(dataFit[,3:56],2,mean))
goodfitnames = names(which(apply(dataFit[,3:56],2,mean) <111.39249))

meanBIC = apply(dataFit[,3:56], 2, mean)

Experiment = data$EXPERIMENT
Id = data$誰..SUBJ.ID
data= data[,-c(which(colnames(data) == "EXPERIMENT"),
which(colnames(data) == "誰..SUBJ.ID") )]

```



```{r}
#colnames(data)

data = data[ , order(names(data))]
#colnames(data)

modelNames = word(colnames(data),1, sep = "\\_")
paramNames = sub('.*\\_', '', colnames(data))

numParamModel = summary(as.factor(modelNames))

#paramNames


#data = data[, modelNames %in% goodfitnames]
#data = data[, paramNames %in% c("gamma", "epsilon")]
modelNames = word(colnames(data),1, sep = "\\_")
paramNames = sub('.*\\_', '', colnames(data))

numParamModel = summary(as.factor(modelNames))

```

1. Correlation between parameters within the models

- calculate correlation betwen parameters in each model

- create Array includinng names Numb of Parameters, mean and max correlation per Model



```{r, correlationWitthinModels}


CorrModelParams = as.data.frame(NA, nrow = c(length(unique(modelNames))), ncol= 5)
accNumbParams = 0 # strting index for columbs in data
for (m in 1:length(unique(modelNames))){
datatemp = data[,(accNumbParams+1) : (accNumbParams + as.numeric(numParamModel[unique(modelNames)[m]]))]
#print(colnames(datatemp))

CorrModelParams[m,1] = unique(modelNames)[m]
CorrModelParams[m,2] = numParamModel[unique(modelNames)[m]]
if (numParamModel[unique(modelNames)[m]] > 1) {
  
print(kable(round(cor(datatemp),2)))
cors = abs(cor(datatemp))
cors[cors == 1] = NA

CorrModelParams[m,3] = max(cors, na.rm = T)
CorrModelParams[m,4] = mean(cors, na.rm = T)
}

CorrModelParams[m,5] = paste(paramNames[modelNames == unique(modelNames)[m]], collapse = ", ")
accNumbParams = cumsum(numParamModel)[m]
}

colnames(CorrModelParams) = c("Name", "nPars", "maxCor", "meanCor", "Pars")

for ( m in 1:length(CorrModelParams[,1])){
  
  CorrModelParams$meanFit[m] = meanBIC[which(names(meanBIC) == CorrModelParams$Name[m])]
  
  
}

cor.test(CorrModelParams$meanFit, CorrModelParams$meanCor)
plot(CorrModelParams$meanFit, CorrModelParams$meanCor)

head(CorrModelParams)

CorrModelParams[order(CorrModelParams$meanCor, decreasing = T),]

#the larger the numbe rof params, the smaller the correlations
cor.test(CorrModelParams$nPars, CorrModelParams$meanCor)




```

2. Correlation beteen scaling and curvature parameters


This shoudl be extended to probability weighting parameters, different error parameters. Would be great to add the identification and type of the noise parameters to the excel file. Same for the others. Optimally we would have a list with all that information, including the formular wirtten down, in R.


```{r}

library(stringr)
Sigmas = str_detect(colnames(data), "sigma")
Epsilons = str_detect(colnames(data), "epsilon")
CPT = str_detect(colnames(data), "CPT")
Gammas = str_detect(colnames(data), "gamma")

## Mean correlation of model specific epsilon, wiht other epsilons ___ must consider rank order correlation
EpsilonsCorr = apply(abs(cor(data[,which(Epsilons == T)], method = "spearman")),2,mean)
#kable(round(cor(data[,which(Epsilons == T)]),2))
mean(cor(data[,which(Epsilons == T)], method = "spearman"))
sort(EpsilonsCorr, decreasing = T)

GammasCorr = apply(abs(cor(data[,which(Gammas == T)], method = "spearman")),2,mean)
# kable(round(cor(data[,which(Gammas == T)]),2))
mean(cor(data[,which(Gammas == T)], method = "spearman"))
sort(GammasCorr, decreasing = T)


GammasCorrMAtrix = cor(data[,which(Epsilons == T)], method = "spearman")

factaalerror = fa(GammasCorrMAtrix, 4)

library(psych)
corMatrix = cor(data[,-c(which(colnames(data) == "EXPERIMENT"),
which(colnames(data) == "誰..SUBJ.ID") )])

 fa.parallel(data, fm = 'minres', fa = 'fa')
factaal = fa(data, 15)


library(qgraph)


models = unique(modelNames)


Listmodels = list(which(modelNames ==models[1]))

for (i in 1: length(models)){
Listmodels =  append(Listmodels, list(which(modelNames ==models[i])))}

params = unique(paramNames)
Listparams = list(which(paramNames ==params[1]))

for (i in 1:length(params)){
Listparams =  append(Listparams, list(which(paramNames ==params[i])))}


modelFAC = as.numeric(as.factor(modelNames))
paramFAC = as.numeric(as.factor(paramNames))


realNames = colnames(data)
colnames(data)  = seq(1:length(colnames(data)))
for (c in 1:dim(data)[2]){
colnames(data)[c] = paste0(paramFAC[c], "_" , modelFAC[c])
}
qgraph(cor(data), minimum = .3, layout = "spring", vsize = 4, groups = Listparams, legend = T, graph = "pcor")


qgraph(cor(data), minimum = .3, layout = "spring", vsize = 4, groups = Listmodels, grap)

          
FactAnalRes = fa(corMatrix,5, rotate = "none", scores = "Bartlett")


-c(which(colnames(data) == "EXPERIMENT"),
which(colnames(data) == "誰..SUBJ.ID") ) 

# 
# ## Mean absolute Param Correlations in Models with Epsilon
CorrModelParams[CorrModelParams$Name %in% modelNames[which(Epsilons == T)],4]

CorrModelParams[CorrModelParams$Name %in% modelNames[which(Gammas == T)],4]
CorrModelParams[!(CorrModelParams$Name %in% modelNames[which(Epsilons == T)]),4]
# 
# ## Mean absolute Param Correlations in Models with Gamma
# CorrModelParams[CorrModelParams$Name %in% modelNames[which(Gammas == T)],4]
# CorrModelParams[!(CorrModelParams$Name %in% modelNames[which(Gammas == T)]),4]


qgraph(cor(data[, modelNames %in% goodfitnames]), minimum = .3, threshold = .3, layout = "spring", vsize = 4)


```

3. Check for differences between Experiments

```{r}
###  Diffferences between Experiments

anova(lm(CPT.TK__epsilon~EXPERIMENT, data = data))
round(with(data, tapply(CPT.TK__epsilon, EXPERIMENT, mean)),3)
## where do these extreme values come from?
round(with(data, tapply(CPT.TK__epsilon, EXPERIMENT, median)),3)

anova(lm(CPT.TK__gamma~EXPERIMENT, data = data))
with(data, tapply(CPT.TK__gamma, EXPERIMENT, mean))
with(data, tapply(CPT.TK__gamma, EXPERIMENT, median))
```


Quesiotn for further analyses, how much variance does one parameter in onemodel explain in comparable parameters in the other parameters.
Considering the trade-off between the correlation of parameters, the fit to the data, and tje correspondece, of a model's parameters wiht corresponding parameters in the other models. 
Consider the differences between the experimens, identify those situations, where the models make disting predictions.
Mayeb idetify those experiemns and choice trial, where the different models make most distinct predictions.

Historical analysis of the correlation, number of parameters 